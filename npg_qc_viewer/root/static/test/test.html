<!DOCTYPE html>
<html>
<head>
<title>QUnit Test Suite</title>
<link rel="stylesheet" href="../bower_components/qunit/qunit/qunit.css" type="text/css" media="screen">
<script type="text/javascript" src="../bower_components/qunit/qunit/qunit.js"></script>
<script type="text/javascript" src="../bower_components/jquery/jquery.js"></script>
<script type="text/javascript" src="../bower_components/blanket/dist/qunit/blanket.js"></script>
<!-- Your project file goes here -->
<script type="text/javascript" src="../scripts/manual_qc.js" data-cover></script>
<!-- Your tests file goes here -->
<script type="text/javascript" src="test.js"></script>
<script>

  LaneMQCControl.prototype.getRoot = function () {
    return 'test/images';
  };

  QUnit.test("DOM linking", function( assert ) {
    var lane = $("#mqc_lane1");
    assert.notEqual(lane, undefined, "mqc_lane is an instance.");
    assert.equal(lane.data('id_run'), '2', "id_run is 2.");
    assert.equal(lane.data('position'), '3', "position is 3.");
    assert.equal(lane.data('initial'), undefined, "No initial value.");
    var control = new LaneMQCControl(0);
    assert.notEqual(control, undefined, "Control is an instance.");
    control.linkControl(lane);
    assert.notEqual(control.lane_control, undefined, "lane_control in Control is linked.");
    assert.equal(control.lane_control, lane, "Control and lane are correctly linked.");
    assert.equal(control.lane_control.outcome, undefined, "Outcome of lane is not defined.");
  });
  QUnit.test("DOM linking lane with previous status", function( assert ) {
    var lane = $("#mqc_lane2");
    assert.notEqual(lane, undefined, "mqc_lane is an instance.");
    assert.equal(lane.data('id_run'), '3', "id_run is 3.");
    assert.equal(lane.data('position'), '4', "position is 4.");
    assert.notEqual(lane.data('initial'), undefined, "Has initial value.");
    assert.equal(lane.data('initial'), 'Accepted final', "Initial value as expected.");
    var control = new LaneMQCControl(1);
    assert.notEqual(control, undefined, "Control is an instance.");
    control.linkControl(lane);
    assert.notEqual(control.lane_control, undefined, "lane_control in Control is linked.");
  });
  QUnit.test("NPG.QC.RunTitleParser", function(assert){
    var parser = new NPG.QC.RunTitleParser();
    var title1 = parser.parse('');
    assert.equal(title1, null, 'Can deal with empty string.');
    var title2 = parser.parse('Bla bla bla');
    assert.equal(title2, null, 'Can deal with random string');
    var title3 = parser.parse('Results for run number (current run status: qc in progress, taken by user)');
    assert.equal(title3, null, 'Can deal with non valid run_id (lexical validation)');
    var title4 = parser.parse('Results for run (current run status: qc in progress, taken by user)');
    assert.equal(title4, null, 'Can deal with missing run_id (lexical validation)');
    var title = parser.parse('Results for run 16074 (current run status: qc in progress, taken by user)');
    assert.equal(title, '16074', 'Correctly parses run_id from correctly formed title');
  });
  QUnit.test("NPG.QC.RunMQCControl", function(assert){
    var data1 = null; 
    var control = new NPG.QC.RunMQCControl('1');
    var result1 = control.initQC(data1, function () {return true}, function(){return false});
    assert.equal(result1, false, 'Control can deal with null data object.');
    data1 = new Object();
    var result2 = control.initQC(data1, function () {return true}, function(){return false});
    assert.equal(result2, false, 'Control can deal with empty data object');
    data1.taken_by = 'me';
    data1.current_user = 'me';
    data1.has_manual_qc_role = 1;
    data1.current_status_description = 'qc in progress';
    var result3 = control.initQC(data1, function () {return true}, function() {return false});
    assert.equal(result3, true, 'Completes with correct data (qc in progress)');
    data1.current_status_description = 'qc on hold';
    var result31 = control.initQC(data1, function () {return true}, function() {return false});
    assert.equal(result31, true, 'Completes with correct data (qc on hold)');
    //
    data1.taken_by = 'other';
    var result4 = control.initQC(data1, function () {return true}, function() {return false});
    assert.equal(result4, false, 'Does not run if taken by and current user are different');
    data1.taken_by = 'me';
    //
    data1.current_user = 'other';
    var result5 = control.initQC(data1, function () {return true}, function() {return false});
    assert.equal(result5, false, 'Does not run if current user and taken by are different');
    data1.current_user = 'me';
    //
    data1.has_manual_qc_role = '';
    var result6 = control.initQC(data1, function () {return true}, function() {return false});
    assert.equal(result6, false, 'Does not run if has manual qc role is not available');
    data1.has_manual_qc_role = 1;
    //
    data1.current_status_description = 'blablabla';
    var result7 = control.initQC(data1, function () {return true}, function() {return false});
    assert.equal(result7, false, 'Does not run if current status description is a unexpected one');
    data1.current_status_description = 'qc in progress';
  }); 
</SCRIPT>
</head>
<body>
<h1 id="qunit-header">QUnit Test Suite</h1>
<h2 id="qunit-banner"></h2>
<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>

<div id="qunit-fixture">
<div id='mqc_lane1' data-id_run='2' data-position='3' class='lane_mqc_control'><div class='lane_mqc_working'></div></div>
<div id='mqc_lane2' data-id_run='3' data-position='4' data-initial='Accepted final' class='lane_mqc_control'><div class='lane_mqc_working'></div></div>
</div>
</body>
</html>
